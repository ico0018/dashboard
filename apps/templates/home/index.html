{% extends "layouts/base.html" %}

{% block title %} Dashboard {% endblock %} 

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}

    <div class="content">
        <div class="row">
            <div class="col-12">
                <div class="card card-chart">
                    <div class="card-header">
                        <h5 class="card-category">Malware Analysis</h5>
                        <h2 class="card-title">Filetype Distribution</h2>
                        <!-- Dropdown for selecting chart type -->
                        <div class="chart-type-selector">
                            <select id="chartType">
                                <option value="bar">Bar Chart</option>
                                <option value="line">Line Chart</option>
                                <option value="pie">Pie Chart</option>
                            </select>
                        </div>
                        <!-- Checkboxes for selecting file types -->
                        <div class="filetype-filters">
                            <input type="checkbox" id="exeFilter" name="filetype" value="exe" checked> <label for="exeFilter">EXE</label>
                            <input type="checkbox" id="pdfFilter" name="filetype" value="pdf" checked> <label for="pdfFilter">PDF</label>
                            <input type="checkbox" id="docFilter" name="filetype" value="doc" checked> <label for="docFilter">DOC</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-area">
                            <canvas id="malwareDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        var currentChart;

        function fetchAndDisplayMalwareData(chartType) {
            $.getJSON('/malware-data', function(malwareData) {
                console.log("Original data:", malwareData); // Debug: 原始数据

                // Get checked filetypes
                var checkedFiletypes = $('input[name="filetype"]:checked').map(function() {
                    return this.value;
                }).get();
                console.log("Checked filetypes:", checkedFiletypes); // Debug: 选中的文件类型

                // Filter data based on checked filetypes
                var filteredData = malwareData.filter(function(item) {
                    return checkedFiletypes.includes(item.filetype);
                });
                console.log("Filtered data:", filteredData); // Debug: 过滤后的数据

                var labels = filteredData.map(function(item) { return item.filetype; });
                var counts = filteredData.map(function(item) { return item.count; });

                var ctx = document.getElementById('malwareDistributionChart').getContext('2d');
                if (currentChart) {
                    currentChart.destroy();
                }
                currentChart = new Chart(ctx, {
                    type: chartType,
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '# of Samples',
                            data: counts,
                            backgroundColor: 'rgba(0, 123, 255, 0.5)',
                            borderColor: 'rgba(0, 123, 255, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: chartType === 'pie' ? {} : {
                        scales: {
                            yAxes: [{
                                ticks: {
                                    beginAtZero: true
                                }
                            }]
                        }
                    }
                });
            }).fail(function(jqXHR, textStatus, errorThrown) {
                console.error("Error fetching data: ", textStatus, errorThrown); // Debug: 数据请求错误
            });
        }

        // Initial chart display
        fetchAndDisplayMalwareData('bar');

        // Event listener for chart type change
        $('#chartType').change(function() {
            var selectedType = $(this).val();
            fetchAndDisplayMalwareData(selectedType);
        });

        // Event listener for filetype filter change
        $('input[name="filetype"]').change(function() {
            var selectedType = $('#chartType').val();
            fetchAndDisplayMalwareData(selectedType);
        });
    });
</script>
{% endblock javascripts %}
