{% extends "layouts/base.html" %}

{% block title %}Dashboard{% endblock %}

<!-- Specific Page CSS goes HERE -->
{% block stylesheets %}
<style>
  .chart-container {
    padding-bottom: 20px;
  }
  .chart-type-selector {
    display: block;
    margin-top: 10px;
  }
</style>
{% endblock stylesheets %}

{% block content %}
<div class="content">
    <div class="row" id="chartsRow">
        <!-- Charts will be dynamically inserted here -->
    </div>
</div>
{% endblock content %}

<!-- Specific Page JS goes HERE -->
{% block javascripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        var userId = '5'; // Replace with actual user_id retrieval logic

        function createChart(data, queryTitle, chartType, canvasId) {
            var labels = data.map(function(item) { return item.name; });
            var counts = data.map(function(item) { return item.count; });
            var ctx = document.getElementById(canvasId).getContext('2d');

            // Destroy the old chart if it exists
            if (window.charts && window.charts[canvasId]) {
                window.charts[canvasId].destroy();
            }

            // Store chart instance to window.charts for potential destruction later
            window.charts = window.charts || {};
            window.charts[canvasId] = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: queryTitle,
                        data: counts,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(54, 162, 235, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                            'rgba(75, 192, 192, 0.2)',
                            'rgba(153, 102, 255, 0.2)',
                            'rgba(255, 159, 64, 0.2)'
                        ],
                        borderColor: [
                            'rgba(255,99,132,1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: chartType !== 'pie' ? {
                        y: {
                            beginAtZero: true
                        }
                    } : {}
                }
            });
        }

        // Function to fetch and display charts
        function fetchAndDisplayCharts(userId) {
            var endpoint = '/process_user_queries/' + userId;
            $.getJSON(endpoint, function(responseData) {
                // For each query data, create a chart
                responseData.forEach(function(queryData, index) {
                    var chartContainerId = 'chartContainer' + index;
                    var chartCanvasId = 'chartCanvas' + index;

                    // Create the chart container and canvas
                    var chartContainer = $('<div>', { 'class': 'col-lg-4 col-md-6 chart-container', 'id': chartContainerId });
                    var card = $('<div>', { 'class': 'card card-chart' });
                    var cardHeader = $('<div>', { 'class': 'card-header' });
                    var cardBody = $('<div>', { 'class': 'card-body' });
                    var chartArea = $('<div>', { 'class': 'chart-area' });
                    var canvas = $('<canvas>', { 'id': chartCanvasId });

                    // Append elements
                    chartArea.append(canvas);
                    cardBody.append(chartArea);
                    card.append(cardHeader, cardBody);
                    chartContainer.append(card);
                    $('#chartsRow').append(chartContainer);

                    // Create chart type selector
                    var chartTypeSelector = $('<select>', { 'class': 'chart-type-selector', 'id': 'chartType' + index });
                    chartTypeSelector.append('<option value="bar">Bar Chart</option>', '<option value="pie">Pie Chart</option>');
                    cardHeader.append($('<h5>').text(queryData.query_title), chartTypeSelector);

                    // Create the initial chart
                    createChart(queryData.data, queryData.query_title, 'bar', chartCanvasId);

                    // Change event for chart type selector
                    chartTypeSelector.change(function() {
                        var selectedType = $(this).val();
                        createChart(queryData.data, queryData.query_title, selectedType, chartCanvasId);
                    });
                });
            }).fail(function(jqXHR, textStatus, errorThrown) {
                console.error("Error fetching data: ", textStatus, errorThrown);
            });
        }

        // Fetch and display charts for the logged-in user
        fetchAndDisplayCharts(userId);
    });
</script>
{% endblock javascripts %}
